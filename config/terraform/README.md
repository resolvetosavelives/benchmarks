# How to Use This: Provisioning and Managing This Project's Azure Deployments with Terraform

## Setup

Change to the terraform directory (the location of this README file)

    cd config/terraform

Get the .env.who file from 1Password (or wherever it's being stored by the WHO).
If you are creating a .env from scratch, follow the .env setup instructions below.

    source .env.who

Install the Azure command-line interface tool known as `az`. For MacOS:

    brew install az

Login to the `az` CLI - You may be prompted to choose which login account and prompted to 2FA if enabled

    az login

Set your Azure subscription ID to the correct ID identified in the .env file.

    az account show
    az account set --subscription $ARM_SUBSCRIPTION_ID

Install terraform. For MacOS:

    brew install terraform

Initialize terraform

    terraform init

## How to use it

### First: Provision

```
cd config/terraform
source .env.gregory
az login
az account set --subscription $ARM_SUBSCRIPTION_ID
terraform workspace select sandbox
terraform apply
```

### Switching between accounts and workspaces

In order to switch from, for example, the WHO Azure to the Cloud City Azure for testing (using sandbox workspace).

    cd config/terraform
    source .env.cloudcity
    az account set --subscription $ARM_SUBSCRIPTION_ID
    terraform workspace list
    terraform workspace select sandbox
    terraform apply

### Last: Destroy

```
cd config/terraform
source .env.gregory
az login
az account set --subscription 89789ead-0e38-4e72-8fd9-3cdcbe80b4ef
terraform workspace select sandbox
terraform destroy
```

## After Provisioning DevOps, Action is Required

After Azure DevOps is provisioned via Terraform, approval must be granted for the Service Connection
for Azure Devops to access the Azure Container Registry.

Go to the Azure Devops project portal https://dev.azure.com and view the pipeline.
You should see a message on the page that says that the pipeline cannot run until you click this button to approve the
Service Connection.

There may be a non-interactive way to do this but I have not found one so far. To do this,

## .env Setup Instructions for a new Azure subscription

Copy the sample .env from config/terraform/.env.sample to config/terraform/.env.name

Follow instructions in the .env.sample.

### Dealing with Terraform-Generated Secret Values

This is the (official / first-party) way to get the secret values generated by Terraform.

- Taken from: https://www.terraform.io/upgrade-guides/0-14.html#sensitive-values-in-plan-output

```
terraform plan -out=tfplan
terraform show -json tfplan > tfplan.json
```

Open and view the generates JSON file `tfplan.json` and the secret value(s) there in plain text.

## Useful Commands

    az webapp log tail --resource-group IHRBENCHMARK-P-WEU-RG01 --name whoproduction-ihrbenchmark-app-service --slot staging --subscription "IHRBENCHMARK IHR Benchmarks Capacity application hosting"

# WHO-specific Background Things to know

There are certain resources that are "pets" (long-lived things that should never be destroyed).

AzureRM:

- Resource Group: IHRBENCHMARK-MAIN-WEU-RG01
- Resource Group: IHRBENCHMARK-P-WEU-RG01
- Resource Group: IHRBENCHMARK-T-WEU-RG01
  Azure DevOps:
- Azure DevOps Project: IHRBENCHMARK

# Things to Know About Terraform on this Project

## Lets try to follow the conventions defined here:

- https://www.terraform-best-practices.com/naming
- https://docs.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/resource-naming

### Naming Convention for Azure Resources

![Image showing Azure's suggested naming convention for cloud resources](https://docs.microsoft.com/en-us/azure/cloud-adoption-framework/_images/ready/resource-naming.png)
This image is from https://docs.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/resource-naming

We'll attempt to stick to Azure's suggestions, with a simplifications to omit

| Naming component            | Description                                                                                                                                                                                                                                             |
| :-------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Resource type               | An abbreviation that represents the type of Azure resource or asset. This component is often used as a prefix or suffix in the name. For more information, see Recommended abbreviations for Azure resource types. Examples: rg, vm                     |
| ~~Business unit~~           | Top-level division of your company that owns the subscription or workload the resource belongs to. In smaller organizations, this component might represent a single corporate top-level organizational element. Examples: fin, mktg, product, it, corp |
| Application or service name | Name of the application, workload, or service that the resource is a part of. Examples: navigator, emissions, sharepoint, hadoop                                                                                                                        |
| ~~Subscription type~~       | Summary description of the purpose of the subscription that contains the resource. Often broken down by deployment environment type or specific workloads. Examples: prod, shared, client                                                               |
| ~~Deployment environment~~  | The stage of the development lifecycle for the workload that the resource supports. Examples: prod, dev, qa, stage, test                                                                                                                                |
| ~~Region~~                  | The Azure region where the resource is deployed. Examples: westus, eastus2, westeu, usva, ustx                                                                                                                                                          |

That leaves "Resource type" and "Application or service name". So we'll go with this for now. We are still figuring this out.

### Code Style for Terraform

- Use \_ (underscore) instead of - (dash/hyphen) in all: resource names, data source names, variable names, outputs.
  - Beware that actual cloud resources have many hidden restrictions in their naming conventions. Some cannot contain dashes, some must be camel cased. These conventions refer to Terraform names themselves.
- Only use lowercase letters and numbers.
-

#### Resource and data source arguments

- Do not repeat resource type in resource name (not partially, nor completely):
  - Good: resource "aws_route_table" "public" {}
  - Bad: resource "aws_route_table" "public_route_table" {}
  - Bad: resource "aws_route_table" "public_aws_route_table" {}
- Resource name should be named this if there is no more descriptive and general name available, or if resource module creates single resource of this type (eg, there is single resource of type aws_nat_gateway and multiple resources of typeaws_route_table, so aws_nat_gateway should be named this and aws_route_table should have more descriptive names - like private, public, database).
- Always use singular nouns for names.
- Use - inside arguments values and in places where value will be exposed to a human (eg, inside DNS name of RDS instance).
- Include count argument inside resource blocks as the first argument at the top and separate by newline after it. See example.
- Include tags argument, if supported by resource as the last real argument, following by depends_on and lifecycle, if necessary. All of these should be separated by single empty line. See example.
- When using condition in count argument use boolean value, if it makes sense, otherwise use length or other interpolation. See example.
- To make inverted conditions don't introduce another variable unless really necessary, use 1 - boolean value instead. For example, count = "${1 - var.create_public_subnets}"

## Someday

- https://www.terraform-best-practices.com/code-styling
- https://github.com/antonbabenko/pre-commit-terraform
